<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>WPS.AI | Stock Scorer</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,600;0,700;1,400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --ink:#111827;
  --ink2:#374151;
  --ink3:#6b7280;
  --border:#e5e7eb;
  --shadow:0 10px 30px rgba(17,24,39,.08);
  --gold:#b45309;
  --gold2:#d97706;
  --danger:#b91c1c;
  --ok:#166534;
  --mono:'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
  --sans:'Syne', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji';
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font-family:var(--mono);
}
a{color:inherit}
.nav{
  position:sticky; top:0; z-index:20;
  display:flex; align-items:center; justify-content:space-between;
  padding:14px 18px;
  background:rgba(255,255,255,.9);
  backdrop-filter:saturate(150%) blur(10px);
  border-bottom:1px solid var(--border);
}
.nav-brand{
  font-family:var(--sans);
  font-weight:800;
  letter-spacing:.2px;
  font-size:18px;
}
.nav-brand span{color:var(--gold)}
.nav-tabs{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
.nav-tab{
  font-family:var(--mono);
  font-size:11px;
  font-weight:700;
  padding:8px 10px;
  border:1px solid var(--border);
  background:#fff;
  border-radius:10px;
  cursor:pointer;
  color:var(--ink2);
}
.nav-tab.active{
  border-color:rgba(180,83,9,.35);
  color:var(--ink);
  box-shadow:0 8px 18px rgba(180,83,9,.12);
}
.main{max-width:1100px; margin:0 auto; padding:22px 18px 60px}
.page{display:none}
.page.active{display:block}
h1,h2,h3{font-family:var(--sans); margin:0}
.subhead{margin-top:6px; color:var(--ink3); font-size:12px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  box-shadow:var(--shadow);
  padding:16px;
}
.stack{display:flex; flex-direction:column; gap:14px}
.row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
.label{font-size:10px; font-weight:700; letter-spacing:.8px; color:var(--ink3)}
.input{
  flex:1;
  min-width:240px;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:12px;
  outline:none;
  font-family:var(--mono);
  font-size:12px;
  background:#fff;
}
.input:focus{border-color:rgba(180,83,9,.45); box-shadow:0 0 0 3px rgba(217,119,6,.12)}
.btn{
  padding:10px 14px;
  border:none;
  border-radius:12px;
  background:linear-gradient(90deg, var(--gold), var(--gold2));
  color:#fff;
  font-family:var(--mono);
  font-weight:800;
  cursor:pointer;
  font-size:12px;
}
.btn:disabled{opacity:.55; cursor:not-allowed}
.note{
  font-size:11px;
  color:var(--ink3);
  line-height:1.35;
}
.note b{color:var(--ink2)}
.badge{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#fff;
  font-size:11px;
  color:var(--ink2);
}
.badge .dot{width:8px; height:8px; border-radius:99px; background:var(--gold)}
.grid{
  display:grid;
  grid-template-columns:repeat(12, 1fr);
  gap:12px;
}
.col-12{grid-column:span 12}
.col-8{grid-column:span 8}
.col-7{grid-column:span 7}
.col-6{grid-column:span 6}
.col-5{grid-column:span 5}
.col-4{grid-column:span 4}
@media (max-width:900px){
  .col-8,.col-7,.col-6,.col-5,.col-4{grid-column:span 12}
  .nav{gap:12px; flex-wrap:wrap}
  .nav-tabs{justify-content:flex-start}
}
.hr{height:1px; background:var(--border); margin:10px 0}
.kpi{
  display:flex; flex-direction:column; gap:8px;
  border:1px solid var(--border);
  background:#fff;
  border-radius:18px;
  padding:14px;
}
.kpi-title{font-size:10px; font-weight:800; letter-spacing:.8px; color:var(--ink3)}
.kpi-score{font-family:var(--sans); font-size:44px; font-weight:800; color:var(--gold); line-height:1}
.kpi-verdict{font-size:14px; font-weight:800; color:var(--ink)}
.summary{
  border:1px solid rgba(180,83,9,.25);
  background:rgba(217,119,6,.06);
  border-radius:18px;
  padding:14px;
  color:#1f2937;
  line-height:1.45;
}
.pillar{
  border:1px solid var(--border);
  background:#fff;
  border-radius:16px;
  padding:12px;
  min-height:110px;
}
.pillar-head{display:flex; justify-content:space-between; align-items:baseline; gap:10px; margin-bottom:8px}
.pillar-name{font-size:12px; font-weight:900; color:var(--ink)}
.pillar-score{font-size:12px; font-weight:900; color:var(--gold)}
.pillar-body{font-size:11px; color:var(--ink3); line-height:1.35}
.list{
  display:flex; flex-direction:column; gap:8px;
}
.source{
  display:flex; gap:10px; align-items:center;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--border);
  background:#fff;
  text-decoration:none;
  font-size:11px;
  color:var(--ink2);
}
.source:hover{border-color:rgba(180,83,9,.35)}
.small{font-size:10px; color:var(--ink3)}
.loading{
  display:none;
  text-align:center;
  padding:34px 10px;
  font-weight:900;
  color:var(--gold);
  letter-spacing:1px;
}
.error{
  border:1px solid rgba(185,28,28,.25);
  background:rgba(185,28,28,.06);
  border-radius:18px;
  padding:14px;
  color:#7f1d1d;
  line-height:1.45;
}
.error .title{font-weight:900; color:var(--danger); margin-bottom:6px}
.mono{font-family:var(--mono)}
</style>
</head>

<body>
<nav class="nav">
  <div class="nav-brand">WPS<span>.</span>AI</div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showPage('scorer', this)">SCORER</button>
    <button class="nav-tab" onclick="showPage('compare', this)">COMPARE</button>
    <button class="nav-tab" onclick="showPage('checklist', this)">CHECKLIST</button>
    <button class="nav-tab" onclick="showPage('journal', this)">JOURNAL</button>
    <button class="nav-tab" onclick="showPage('watchlist', this)">WATCHLIST</button>
  </div>
</nav>

<div class="main">
  <div class="page active" id="page-scorer">
    <div style="margin-bottom:18px;">
      <h1 style="font-size:32px;">AI Stock Scorer</h1>
      <div class="subhead">Institutional-style 7-Pillar snapshot. Uses the most recent web-available data and shows sources.</div>
    </div>

    <div class="card stack">
      <div class="row">
        <div class="badge" title="Client-side API keys are risky. A backend proxy is recommended.">
          <span class="dot"></span>
          <span><b>Note:</b> Direct API-key mode is convenient and unsafe.</span>
        </div>
      </div>

      <div class="grid">
        <div class="col-12">
          <div class="row" style="margin-bottom:8px;">
            <div class="label">API KEY</div>
            <div class="small">Stored locally (optional). Best practice: use a server proxy.</div>
          </div>
          <div class="row">
            <input type="password" class="input" id="geminiKey" placeholder="AIza..." autocomplete="off" />
            <label class="badge" style="cursor:pointer;">
              <input type="checkbox" id="rememberKey" style="margin:0;" />
              <span>Remember on this device</span>
            </label>
          </div>
        </div>

        <div class="col-12">
          <div class="row" style="margin-bottom:8px;">
            <div class="label">STOCK SYMBOL</div>
            <div class="small">Example: JINDALSAW (NSE). Case does not matter.</div>
          </div>
          <div class="row">
            <input class="input" id="stockInput" placeholder="e.g. JINDALSAW" />
            <button class="btn" id="analyzeBtn">ANALYZE</button>
          </div>
        </div>

        <div class="col-12">
          <div class="note">
            <b>Output discipline:</b> The model is required to return strict JSON with dates and per-metric citations. If it does not, the UI will tell you instead of crashing like a toddler.
          </div>
        </div>
      </div>
    </div>

    <div id="loading" class="loading">SEARCHING LIVE MARKET DATA...</div>
    <div id="resultsPanel" class="stack" style="margin-top:14px;"></div>
  </div>

  <div class="page" id="page-compare">
    <div class="card">
      <h2>Comparison</h2>
      <div class="subhead">Placeholder. You can wire this to run two symbols and diff pillars.</div>
    </div>
  </div>

  <div class="page" id="page-checklist">
    <div class="card">
      <h2>Checklist</h2>
      <div class="subhead">Placeholder. Great place for a pre-trade sanity list and risk rules.</div>
    </div>
  </div>

  <div class="page" id="page-journal">
    <div class="card">
      <h2>Journal</h2>
      <div class="subhead">Placeholder. Add entries, tag by thesis, and track post-mortems.</div>
    </div>
  </div>

  <div class="page" id="page-watchlist">
    <div class="card">
      <h2>Watchlist</h2>
      <div class="subhead">Placeholder. Store symbols in localStorage and rerun quickly.</div>
    </div>
  </div>
</div>

<script>
/* ---------------------------
   Navigation
---------------------------- */
function showPage(id, btn){
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  btn.classList.add('active');
}

/* ---------------------------
   Small utilities
---------------------------- */
const $ = (sel) => document.querySelector(sel);

function setBusy(isBusy){
  const btn = $('#analyzeBtn');
  const sym = $('#stockInput');
  const key = $('#geminiKey');
  btn.disabled = isBusy;
  sym.disabled = isBusy;
  key.disabled = isBusy;
  btn.textContent = isBusy ? 'ANALYZING...' : 'ANALYZE';
  $('#loading').style.display = isBusy ? 'block' : 'none';
}

function escapeHtml(str){
  return String(str ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function isSafeHttpUrl(url){
  try{
    const u = new URL(url);
    return u.protocol === 'http:' || u.protocol === 'https:';
  }catch(_){ return false; }
}

function normalizeSymbol(s){
  return String(s || '').trim().toUpperCase().replace(/[^A-Z0-9._-]/g,'');
}

/* ---------------------------
   Robust JSON parsing
---------------------------- */
function stripCodeFences(text){
  const t = String(text || '').trim();
  return t.replace(/^```(?:json)?\s*/i,'').replace(/\s*```$/,'').trim();
}

function extractFirstJsonBlob(text){
  const t = stripCodeFences(text);
  if(t.startsWith('[')) return t;

  const start = t.indexOf('{');
  if(start === -1) return null;

  let depth = 0;
  for(let i = start; i < t.length; i++){
    const ch = t[i];
    if(ch === '{') depth++;
    if(ch === '}') depth--;
    if(depth === 0){
      return t.slice(start, i+1);
    }
  }
  return null;
}

function safeParseJson(text){
  const direct = stripCodeFences(text);
  try{ return JSON.parse(direct); }catch(_){}

  const blob = extractFirstJsonBlob(text);
  if(!blob) return null;
  try{ return JSON.parse(blob); }catch(_){ return null; }
}

/* ---------------------------
   Rendering
---------------------------- */
function renderError(title, details){
  $('#resultsPanel').innerHTML = `
    <div class="error">
      <div class="title">${escapeHtml(title)}</div>
      <div class="mono" style="font-size:11px;">${escapeHtml(details || '')}</div>
    </div>
  `;
}

function renderResult(d, meta){
  const symbol = escapeHtml(d.symbol || '');
  const company = escapeHtml(d.company || '');
  const cmp = (d.cmp != null) ? escapeHtml(String(d.cmp)) : '—';
  const currency = escapeHtml(d.currency || '₹');
  const wps = (d.wps != null) ? Math.round(Number(d.wps)) : null;
  const verdict = escapeHtml(d.verdict || '—');
  const summary = escapeHtml(d.summary || '');
  const asOf = escapeHtml(d.as_of || d.asOf || '');

  const pillars = Array.isArray(d.pillars) ? d.pillars : [];
  const redFlags = Array.isArray(d.red_flags) ? d.red_flags : [];
  const assumptions = Array.isArray(d.assumptions) ? d.assumptions : [];

  const grounded = meta?.groundingChunks
    ?.map(c => c?.web)
    ?.filter(w => w?.uri && isSafeHttpUrl(w.uri))
    ?.slice(0, 20) || [];

  const modelSources = Array.isArray(d.sources)
    ? d.sources.filter(s => s?.url && isSafeHttpUrl(s.url)).slice(0, 20)
    : [];

  const sources = grounded.length
    ? grounded.map(w => ({ title: w.title || w.uri, url: w.uri }))
    : modelSources;

  const pillarCards = pillars.length ? pillars.map(p => {
    const name = escapeHtml(p.name || 'Pillar');
    const score = (p.score != null) ? escapeHtml(String(p.score)) : '—';
    const body = escapeHtml(p.summary || p.note || '');
    return `
      <div class="pillar">
        <div class="pillar-head">
          <div class="pillar-name">${name}</div>
          <div class="pillar-score">${score}%</div>
        </div>
        <div class="pillar-body">${body}</div>
      </div>
    `;
  }).join('') : `
    <div class="pillar" style="grid-column:span 12;">
      <div class="pillar-head">
        <div class="pillar-name">Pillars</div>
        <div class="pillar-score">—</div>
      </div>
      <div class="pillar-body">No pillar breakdown returned. Your prompt or model response needs tightening.</div>
    </div>
  `;

  const redFlagsHtml = redFlags.length ? `
    <div class="card">
      <div class="label" style="margin-bottom:8px;">RED FLAGS</div>
      <div class="list">
        ${redFlags.map(x => `<div class="source"><span class="mono">${escapeHtml(x)}</span></div>`).join('')}
      </div>
    </div>
  ` : '';

  const assumptionsHtml = assumptions.length ? `
    <div class="card">
      <div class="label" style="margin-bottom:8px;">ASSUMPTIONS</div>
      <div class="list">
        ${assumptions.map(x => `<div class="source"><span class="mono">${escapeHtml(x)}</span></div>`).join('')}
      </div>
    </div>
  ` : '';

  const sourcesHtml = sources.length ? sources.map(s => `
      <a class="source" href="${escapeHtml(s.url)}" target="_blank" rel="noopener noreferrer">
        <div style="min-width:10px; height:10px; border-radius:99px; background:var(--gold)"></div>
        <div>
          <div style="font-weight:800; color:var(--ink)">${escapeHtml(s.title || s.url)}</div>
          <div class="small">${escapeHtml(s.url)}</div>
        </div>
      </a>
  `).join('') : `<div class="small">No sources returned. That usually means no grounding metadata or the model skipped citations.</div>`;

  $('#resultsPanel').innerHTML = `
    <div class="grid">
      <div class="col-7">
        <div class="card">
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <div class="label">SYMBOL</div>
              <div style="font-family:var(--sans); font-weight:900; font-size:28px; margin-top:4px;">${symbol || '—'}</div>
              <div class="subhead">${company}</div>
            </div>
            <div style="text-align:right;">
              <div class="label">CMP</div>
              <div style="font-family:var(--sans); font-weight:900; font-size:22px; margin-top:4px; color:var(--gold);">
                ${currency}${cmp}
              </div>
              <div class="small">${asOf ? ('As of ' + asOf) : ''}</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="summary">${summary || 'No summary returned.'}</div>
        </div>
      </div>

      <div class="col-5">
        <div class="kpi" style="height:100%;">
          <div class="kpi-title">WPS SCORE</div>
          <div class="kpi-score">${wps != null && !Number.isNaN(wps) ? wps : '—'}%</div>
          <div class="kpi-verdict">${verdict}</div>
        </div>
      </div>

      <div class="col-12">
        <div class="grid">
          ${pillarCards}
        </div>
      </div>

      <div class="col-12">
        <div class="card">
          <div class="label" style="margin-bottom:8px;">SOURCES</div>
          <div class="list">
            ${sourcesHtml}
          </div>
        </div>
      </div>
    </div>
    ${redFlagsHtml}
    ${assumptionsHtml}
  `;
}

/* ---------------------------
   Gemini call (direct, client-side)
   Best practice: move this to your backend and hide the key.
---------------------------- */
async function analyzeStock(){
  const symbol = normalizeSymbol($('#stockInput').value);
  const apiKey = ($('#geminiKey').value || '').trim();

  if(!symbol) return renderError('Missing symbol', 'Enter a stock symbol (example: JINDALSAW).');
  if(!apiKey) return renderError('Missing API key', 'Paste a valid Gemini API key.');

  const remember = $('#rememberKey').checked;
  try{
    if(remember) localStorage.setItem('wps_gemini_key', apiKey);
    else localStorage.removeItem('wps_gemini_key');
  }catch(_){}

  setBusy(true);
  $('#resultsPanel').innerHTML = '';

  const prompt = `
You are a finance analyst. Produce a strict JSON response ONLY (no markdown, no commentary).
Task: Analyze the NSE stock symbol "${symbol}" using a 7-pillar scoring method.

Rules:
- Use the most recent publicly available data you can find via web search.
- Every major claim should include an as-of date. Do not invent dates.
- If data is not available, set the field to null and add a note in assumptions.
- Keep the summary concise and audit-friendly.

Return JSON with this exact shape:
{
  "symbol": "${symbol}",
  "company": "string",
  "exchange": "NSE",
  "currency": "₹",
  "cmp": number|null,
  "as_of": "YYYY-MM-DD"|null,
  "wps": number (0-100),
  "verdict": "string",
  "summary": "string",
  "pillars": [
    {"name":"Financial Health","score":0-100,"summary":"string"},
    {"name":"Earnings Performance","score":0-100,"summary":"string"},
    {"name":"Company Management","score":0-100,"summary":"string"},
    {"name":"Future Growth","score":0-100,"summary":"string"},
    {"name":"Intrinsic Value","score":0-100,"summary":"string"},
    {"name":"Capital Efficiency","score":0-100,"summary":"string"},
    {"name":"Market Sentiment","score":0-100,"summary":"string"}
  ],
  "red_flags": ["string"...],
  "assumptions": ["string"...],
  "sources": [{"title":"string","url":"https://..."}...]
}
`.trim();

  try{
    const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${encodeURIComponent(apiKey)}`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        tools: [{ google_search: {} }],
        generationConfig: { temperature: 0.2 }
      })
    });

    if(!resp.ok){
      const bodyText = await resp.text().catch(() => '');
      throw new Error(`HTTP ${resp.status}. ${bodyText.slice(0, 400)}`);
    }

    const data = await resp.json();
    const candidate = data?.candidates?.[0];
    const rawText = candidate?.content?.parts?.[0]?.text || '';
    const parsed = safeParseJson(rawText);

    if(!parsed){
      renderError('Model returned malformed JSON', rawText.slice(0, 1200) || 'Empty response.');
      return;
    }

    const meta = candidate?.groundingMetadata || null;
    renderResult(parsed, meta);

  }catch(e){
    renderError('Request failed', e?.message || String(e));
  }finally{
    setBusy(false);
  }
}

/* ---------------------------
   Bindings + key restore
---------------------------- */
(function init(){
  const btn = $('#analyzeBtn');
  btn.addEventListener('click', analyzeStock);

  $('#stockInput').addEventListener('keydown', (e) => {
    if(e.key === 'Enter' && !btn.disabled) analyzeStock();
  });

  try{
    const saved = localStorage.getItem('wps_gemini_key');
    if(saved){
      $('#geminiKey').value = saved;
      $('#rememberKey').checked = true;
    }
  }catch(_){}
})();
</script>
</body>
</html>