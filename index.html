<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>WPS.AI | Institutional Scorer & Backtester</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --ink:#111827; --ink2:#374151; --ink3:#6b7280;
  --border:#e5e7eb; --gold:#b45309; --gold2:#d97706; --danger:#b91c1c;
  --mono:'IBM Plex Mono', monospace; --sans:'Syne', sans-serif;
}
body{ margin:0; background:var(--bg); color:var(--ink); font-family:var(--mono); font-size:13px; }
.nav{ position:sticky; top:0; z-index:20; display:flex; align-items:center; justify-content:space-between; padding:12px 20px; background:rgba(255,255,255,.9); backdrop-filter:blur(10px); border-bottom:1px solid var(--border); }
.nav-brand{ font-family:var(--sans); font-weight:800; font-size:20px; }
.nav-brand span{ color:var(--gold); }
.nav-tab{ padding:8px 12px; border:1px solid var(--border); background:#fff; border-radius:8px; cursor:pointer; font-weight:700; font-size:11px; margin-left:5px; }
.nav-tab.active{ border-color:var(--gold); color:var(--gold); box-shadow:0 4px 12px rgba(180,83,9,0.1); }
.main{ max-width:1100px; margin:0 auto; padding:20px; }
.page{ display:none; } .page.active{ display:block; }
.card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px; margin-bottom:16px; box-shadow:0 4px 20px rgba(0,0,0,0.03); }
.grid{ display:grid; grid-template-columns:repeat(12, 1fr); gap:15px; }
.col-12{ grid-column:span 12; } .col-8{ grid-column:span 8; } .col-4{ grid-column:span 4; }
.label{ font-size:10px; font-weight:700; color:var(--ink3); letter-spacing:1px; margin-bottom:5px; text-transform:uppercase; }
.input{ width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; font-family:var(--mono); margin-bottom:10px; }
.btn{ padding:10px 20px; border:none; border-radius:8px; background:linear-gradient(90deg, var(--gold), var(--gold2)); color:#fff; font-weight:800; cursor:pointer; width:100%; }
.kpi-score{ font-family:var(--sans); font-size:48px; color:var(--gold); line-height:1; }
.pillar{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; }
.pillar-head{ display:flex; justify-content:space-between; font-weight:800; margin-bottom:8px; }
.hr{ height:1px; background:var(--border); margin:15px 0; }
.loading{ display:none; text-align:center; padding:40px; font-weight:800; color:var(--gold); }
.backtest-badge{ background:rgba(217,119,6,0.1); color:var(--gold); padding:4px 8px; border-radius:6px; font-size:10px; font-weight:800; }
</style>
</head>
<body>

<nav class="nav">
  <div class="nav-brand">WPS<span>.</span>AI</div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showPage('scorer', this)">AUDIT</button>
    <button class="nav-tab" onclick="showPage('journal', this)">JOURNAL</button>
  </div>
</nav>

<div class="main">
  <div class="page active" id="page-scorer">
    <div class="card">
      <div class="grid">
        <div class="col-8">
          <div class="label">NSE Symbol</div>
          <input class="input" id="stockInput" placeholder="e.g. JINDALSAW" />
          <div class="label">Gemini API Key</div>
          <input type="password" class="input" id="geminiKey" placeholder="AIza..." />
        </div>
        <div class="col-4" style="display:flex; align-items:flex-end;">
          <button class="btn" id="analyzeBtn">RUN 6-PILLAR AUDIT & BACKTEST</button>
        </div>
      </div>
    </div>

    <div id="loading" class="loading">VERIFYING DATA INTEGRITY...</div>
    <div id="resultsPanel"></div>
  </div>

  <div class="page" id="page-journal">
    <div class="card">
      <h2>Trade Journal</h2>
      <div id="journalEntries">No entries yet. Run an audit to save a trade.</div>
    </div>
  </div>
</div>

<script>
const $ = (s) => document.querySelector(s);
let currentAnalysis = null;

function showPage(id, btn){
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  btn.classList.add('active');
}

async function analyzeStock(){
  const sym = $('#stockInput').value.trim().toUpperCase();
  const key = $('#geminiKey').value.trim();
  if(!sym || !key) return alert("Enter Symbol & Key");

  $('#loading').style.display = 'block';
  $('#resultsPanel').innerHTML = '';

  const systemInstructions = `
    You are a strictly factual financial auditor. 
    RESPONSE RULE: Output ONLY valid JSON. No conversational text, no markdown.
    STRATEGY: 6-Pillar Methodology (RS 15%, Technical 25%, Sector 10%, Fundamental 20%, Insiders 15%, R:R 15%).
    BACKTEST RULE: Look at historical data from the last 12 months. Count successful entries based on the 45-degree P&F rule.
  `;

  const prompt = `
    Audit NSE:${sym}. 
    1. Relative Strength: vs Nifty 50[cite: 5, 6].
    2. Technical: 45-deg P&F trendline status[cite: 10, 12].
    3. Fundamentals: YoY Profit > 25%, Debt/Equity < 0.5[cite: 19, 21].
    4. Backtest: % Win rate of this strategy on this stock over 12 months[cite: 31].
    
    JSON Schema:
    {
      "symbol": "${sym}", "company": "Name", "cmp": 0, "wps": 0, "verdict": "Action",
      "backtest": {"win_rate": 0, "trades": 0, "avg_return": 0},
      "pillars": [{"name": "string", "score": 0, "summary": "string"}],
      "targets": {"t1": 0, "sl": 0}
    }
  `;

  try {
    const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        contents: [{ parts: [{ text: systemInstructions + prompt }] }],
        generationConfig: { temperature: 0.1, responseMimeType: "application/json" }
      })
    });

    const data = await resp.json();
    const rawJson = data.candidates[0].content.parts[0].text;
    currentAnalysis = JSON.parse(rawJson);
    render(currentAnalysis);
  } catch (e) {
    $('#resultsPanel').innerHTML = `<div class="card" style="color:var(--danger)"><b>Audit Failed:</b> ${e.message}</div>`;
  } finally {
    $('#loading').style.display = 'none';
  }
}

function render(d){
  const pillarsHtml = d.pillars.map(p => `
    <div class="pillar">
      <div class="pillar-head"><span>${p.name}</span><span>${p.score}%</span></div>
      <div style="color:var(--ink3); font-size:11px;">${p.summary}</div>
    </div>
  `).join('');

  $('#resultsPanel').innerHTML = `
    <div class="grid">
      <div class="col-8">
        <div class="card">
          <h1 style="margin:0; font-family:var(--sans);">${d.symbol} <span class="backtest-badge">BACKTEST: ${d.backtest.win_rate}% Win Rate</span></h1>
          <div class="label">${d.company} | CMP: ₹${d.cmp}</div>
          <div class="hr"></div>
          <p>${d.verdict}: Based on ${d.backtest.trades} historical signals[cite: 2, 4].</p>
          <div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px;">
            <div class="pillar"><b>Target 1:</b> ₹${d.targets.t1}</div>
            <div class="pillar" style="color:var(--danger)"><b>Stop Loss:</b> ₹${d.targets.sl}</div>
          </div>
        </div>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:15px;">${pillarsHtml}</div>
      </div>
      <div class="col-4">
        <div class="card" style="text-align:center;">
          <div class="label">Final WPS Score</div>
          <div class="kpi-score">${d.wps}%</div>
          <div class="hr"></div>
          <button class="btn" onclick="saveToJournal()">SAVE TO JOURNAL</button>
        </div>
      </div>
    </div>
  `;
}

function saveToJournal(){
  if(!currentAnalysis) return;
  const entry = `<div class="pillar" style="margin-bottom:10px;"><b>${currentAnalysis.symbol}</b> - Score: ${currentAnalysis.wps}% | Date: ${new Date().toLocaleDateString()}</div>`;
  const container = $('#journalEntries');
  if(container.innerHTML.includes("No entries")) container.innerHTML = "";
  container.innerHTML += entry;
  alert("Trade Saved to Journal.");
}

$('#analyzeBtn').addEventListener('click', analyzeStock);
</script>
</body>
</html>