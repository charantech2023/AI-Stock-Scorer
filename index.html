<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WPS.AI PRO | Yahoo Finance Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Syne:wght@700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #f8fafc; --card: #ffffff; --ink: #0f172a; --ink2: #334155; --ink3: #64748b;
      --border: #e2e8f0; --gold: #b45309; --gold-gradient: linear-gradient(135deg, #b45309 0%, #d97706 100%);
      --success: #059669; --success-light: #d1fae5; --warning: #d97706; --danger: #dc2626;
      --mono: 'IBM Plex Mono', monospace; --sans: 'Syne', sans-serif;
    }
    body { background: var(--bg); color: var(--ink); font-family: var(--mono); font-size: 14px; }
    .nav { position: sticky; top: 0; z-index: 50; display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; background: rgba(255,255,255,0.9); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); }
    .nav-brand { font-family: var(--sans); font-weight: 800; font-size: 24px; }
    .nav-brand span { color: var(--gold); }
    .nav-tabs { display: flex; gap: 8px; }
    .nav-tab { padding: 10px 20px; border: 1px solid var(--border); background: white; border-radius: 40px; cursor: pointer; font-weight: 700; transition: all 0.2s; }
    .nav-tab:hover, .nav-tab.active { border-color: var(--gold); background: var(--gold-gradient); color: white; }
    .main { max-width: 1400px; margin: 0 auto; padding: 24px; }
    .page { display: none; }
    .page.active { display: block; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; }
    .col-12 { grid-column: span 12; }
    .col-8 { grid-column: span 8; }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    .col-3 { grid-column: span 3; }
    .label { font-size: 11px; font-weight: 700; color: var(--ink3); text-transform: uppercase; margin-bottom: 6px; }
    .input, .select { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 12px; font-family: var(--mono); margin-bottom: 16px; }
    .input:focus { outline: none; border-color: var(--gold); }
    .btn { padding: 14px 24px; border: none; border-radius: 40px; background: var(--gold-gradient); color: white; font-weight: 800; cursor: pointer; width: 100%; transition: all 0.2s; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(180,83,9,0.3); }
    .btn-secondary { background: white; color: var(--ink); border: 1px solid var(--border); }
    .kpi-score { font-family: var(--sans); font-size: 64px; font-weight: 800; color: var(--gold); line-height: 1; }
    .pillar { background: var(--bg); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 12px; }
    .pillar-head { display: flex; justify-content: space-between; font-weight: 800; margin-bottom: 8px; }
    .pillar-score { color: var(--gold); background: rgba(180,83,9,0.1); padding: 4px 8px; border-radius: 20px; }
    .loading { display: none; text-align: center; padding: 40px; font-weight: 800; color: var(--gold); }
    .loading::after { content: ''; display: inline-block; width: 20px; height: 20px; margin-left: 10px; border: 2px solid var(--gold); border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .price-tag { font-size: 32px; font-weight: 800; color: var(--gold); }
    .change-positive { color: var(--success); }
    .change-negative { color: var(--danger); }
    .metric-box { background: var(--bg); border-radius: 12px; padding: 16px; text-align: center; }
    .metric-value { font-size: 24px; font-weight: 800; }
    .signal-badge { padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 12px; }
    .signal-buy { background: var(--success-light); color: var(--success); }
    .signal-sell { background: #fee2e2; color: var(--danger); }
    .signal-neutral { background: #fef3c7; color: var(--warning); }
    .error-box { background: #fee2e2; color: var(--danger); padding: 20px; border-radius: 12px; border: 1px solid var(--danger); }
    .real-data { background: var(--success-light); color: var(--success); padding: 12px; border-radius: 8px; margin-bottom: 20px; font-weight: 600; }
    .trade-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 10px; padding: 10px; border-bottom: 1px solid var(--border); font-size: 12px; }
    .trade-header { font-weight: 700; color: var(--ink3); text-transform: uppercase; font-size: 10px; }
    .chart-container { position: relative; height: 300px; margin: 20px 0; }
  </style>
</head>
<body>
  <nav class="nav">
    <div class="nav-brand">WPS<span>.</span>AI PRO</div>
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showPage('scorer', this)">üìä REAL-TIME</button>
      <button class="nav-tab" onclick="showPage('backtest', this)">üìà BACKTEST</button>
      <button class="nav-tab" onclick="showPage('journal', this)">üìì JOURNAL</button>
    </div>
  </nav>

  <div class="main">
    <!-- Real-Time Analysis Page -->
    <div class="page active" id="page-scorer">
      <div class="card">
        <div class="grid">
          <div class="col-6">
            <div class="label">üáÆüá≥ NSE SYMBOL</div>
            <input class="input" id="stockInput" placeholder="e.g. LAURUSLABS" value="LAURUSLABS" />
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
              <span class="btn btn-secondary" style="width: auto; padding: 8px 16px;" onclick="setSymbol('RELIANCE')">RELIANCE</span>
              <span class="btn btn-secondary" style="width: auto; padding: 8px 16px;" onclick="setSymbol('TCS')">TCS</span>
              <span class="btn btn-secondary" style="width: auto; padding: 8px 16px;" onclick="setSymbol('LAURUSLABS')">LAURUSLABS</span>
              <span class="btn btn-secondary" style="width: auto; padding: 8px 16px;" onclick="setSymbol('JINDALSAW')">JINDALSAW</span>
            </div>
          </div>
          <div class="col-6">
            <div class="label">üîë ALPHA VANTAGE KEY (Optional)</div>
            <input type="password" class="input" id="apiKey" placeholder="Enter key for backup source" />
            <div style="font-size: 11px; color: var(--ink3);">
              Primary: Yahoo Finance ‚Ä¢ Backup: Alpha Vantage (25/day)
            </div>
          </div>
          <div class="col-12">
            <button class="btn" id="analyzeBtn">üöÄ ANALYZE STOCK</button>
          </div>
        </div>
      </div>

      <div id="loading" class="loading">FETCHING DATA...</div>
      <div id="resultsPanel"></div>
    </div>

    <!-- Backtest Page -->
    <div class="page" id="page-backtest">
      <div class="card">
        <h2 style="font-family: var(--sans); margin-bottom: 20px;">üìà Strategy Backtest</h2>
        <div class="grid">
          <div class="col-3">
            <div class="label">Symbol</div>
            <input class="input" id="backtestSymbol" value="LAURUSLABS" />
          </div>
          <div class="col-3">
            <div class="label">Strategy</div>
            <select class="select" id="strategySelect">
              <option value="sma_cross">SMA Crossover (20/50)</option>
              <option value="rsi_mean_reversion">RSI Mean Reversion</option>
              <option value="macd">MACD Signal</option>
            </select>
          </div>
          <div class="col-3">
            <div class="label">Period</div>
            <select class="select" id="periodSelect">
              <option value="3mo">3 Months</option>
              <option value="6mo">6 Months</option>
              <option value="1y">1 Year</option>
            </select>
          </div>
          <div class="col-3">
            <div class="label">Initial Capital (‚Çπ)</div>
            <input class="input" id="initialCapital" value="100000" type="number" />
          </div>
        </div>
        <button class="btn" onclick="runBacktest()">‚ñ∂ RUN BACKTEST</button>
        <div id="backtestResults" style="margin-top: 20px;"></div>
      </div>
    </div>

    <!-- Journal Page -->
    <div class="page" id="page-journal">
      <div class="card">
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
          <h2 style="font-family: var(--sans);">üìì Trade Journal</h2>
          <button class="btn btn-secondary" onclick="exportJournal()" style="width: auto;">üì• Export</button>
        </div>
        <div id="journalEntries"></div>
        <button class="btn btn-secondary" onclick="clearJournal()" style="margin-top: 20px;">üóëÔ∏è Clear All</button>
      </div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    
    let currentAnalysis = null;
    let journal = JSON.parse(localStorage.getItem('wps_journal') || '[]');
    updateJournalDisplay();

    function showPage(pageId, btn) {
      $$('.page').forEach(p => p.classList.remove('active'));
      $$('.nav-tab').forEach(t => t.classList.remove('active'));
      $(`#page-${pageId}`).classList.add('active');
      if (btn) btn.classList.add('active');
    }

    function setSymbol(symbol) {
      $('#stockInput').value = symbol;
    }

    // ==================== YAHOO FINANCE (PRIMARY) ====================
    async function fetchYahooFinance(symbol) {
      const cleanSymbol = symbol.replace('.NS', '').toUpperCase().trim();
      
      // Try multiple CORS proxies in case one fails
      const proxies = [
        'https://api.allorigins.win/raw?url=',
        'https://corsproxy.io/?',
        'https://api.codetabs.com/v1/proxy?quest='
      ];
      
      for (const proxy of proxies) {
        try {
          const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${cleanSymbol}.NS?range=1d&interval=1d`;
          const url = proxy + encodeURIComponent(yahooUrl);
          
          console.log(`Trying proxy: ${proxy.substring(0, 30)}...`);
          
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
          
          const response = await fetch(url, { signal: controller.signal });
          clearTimeout(timeoutId);
          
          if (!response.ok) continue;
          
          const data = await response.json();
          
          if (data.chart?.result?.[0]) {
            const result = data.chart.result[0];
            const meta = result.meta;
            const price = meta.regularMarketPrice;
            
            if (!price || price === 0) continue;
            
            const prevClose = meta.previousClose || meta.chartPreviousClose || price;
            const change = price - prevClose;
            
            return {
              price: price,
              change: change,
              percentChange: (change / prevClose) * 100,
              dayHigh: meta.regularMarketDayHigh || price * 1.02,
              dayLow: meta.regularMarketDayLow || price * 0.98,
              volume: meta.regularMarketVolume || 1000000,
              open: meta.regularMarketOpen || price - change,
              yearHigh: meta.fiftyTwoWeekHigh || price * 1.3,
              yearLow: meta.fiftyTwoWeekLow || price * 0.7,
              company: meta.shortName || meta.longName || cleanSymbol,
              source: 'Yahoo Finance',
              timestamp: new Date()
            };
          }
        } catch (e) {
          console.log(`Proxy ${proxy.substring(0, 20)} failed:`, e.message);
          continue;
        }
      }
      
      throw new Error('All Yahoo Finance proxies failed');
    }

    // ==================== ALPHA VANTAGE (BACKUP) ====================
    async function fetchAlphaVantage(symbol, apiKey) {
      if (!apiKey || apiKey === 'demo') throw new Error('No API key');
      
      const formats = [`${symbol}.NS`, `${symbol}.BO`, `NSE:${symbol}`];
      
      for (const format of formats) {
        try {
          const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${format}&apikey=${apiKey}`;
          const response = await fetch(url);
          const data = await response.json();
          
          if (data.Note || data.Information) {
            console.log('Alpha Vantage rate limit');
            break;
          }
          
          const quote = data['Global Quote'];
          if (quote && quote['05. price']) {
            return {
              price: parseFloat(quote['05. price']),
              change: parseFloat(quote['09. change'] || 0),
              percentChange: parseFloat((quote['10. change percent'] || '0').replace('%', '')),
              dayHigh: parseFloat(quote['03. high'] || quote['05. price']),
              dayLow: parseFloat(quote['04. low'] || quote['05. price']),
              volume: parseInt(quote['06. volume'] || 1000000),
              open: parseFloat(quote['02. open'] || quote['05. price']),
              yearHigh: parseFloat(quote['05. price']) * 1.2,
              yearLow: parseFloat(quote['05. price']) * 0.8,
              company: symbol,
              source: `Alpha Vantage (${format})`,
              timestamp: new Date()
            };
          }
        } catch (e) {
          console.log(`Alpha Vantage ${format} failed:`, e.message);
        }
      }
      
      throw new Error('Alpha Vantage failed');
    }

    // ==================== DEMO DATA (LAST RESORT) ====================
    function getDemoData(symbol) {
      const basePrices = {
        'RELIANCE': 2856.75, 'TCS': 3892.30, 'INFY': 1542.80, 'HDFC': 1678.45,
        'TATAMOTORS': 943.25, 'ITC': 428.65, 'SBIN': 765.40, 'ICICIBANK': 1085.20,
        'AXISBANK': 1123.55, 'JINDALSAW': 285.50, 'LAURUSLABS': 452.30
      };
      
      const base = basePrices[symbol] || 1000 + Math.random() * 2000;
      const change = (Math.random() - 0.5) * base * 0.02;
      
      return {
        price: base,
        change: change,
        percentChange: (change / base) * 100,
        dayHigh: base * 1.02,
        dayLow: base * 0.98,
        volume: Math.floor(1000000 + Math.random() * 5000000),
        open: base - change,
        yearHigh: base * 1.3,
        yearLow: base * 0.7,
        company: `${symbol} Ltd`,
        source: '‚ö†Ô∏è DEMO DATA',
        timestamp: new Date(),
        isDemo: true
      };
    }

    // ==================== MAIN FETCH FUNCTION ====================
    async function fetchStockData(symbol) {
      const apiKey = $('#apiKey').value.trim();
      
      // Try Yahoo Finance first (best coverage)
      try {
        console.log('Trying Yahoo Finance...');
        return await fetchYahooFinance(symbol);
      } catch (e) {
        console.log('Yahoo Finance failed:', e.message);
      }
      
      // Try Alpha Vantage as backup
      if (apiKey && apiKey !== 'demo') {
        try {
          console.log('Trying Alpha Vantage...');
          return await fetchAlphaVantage(symbol, apiKey);
        } catch (e) {
          console.log('Alpha Vantage failed:', e.message);
        }
      }
      
      // Last resort: demo data
      console.warn('All sources failed, using demo data');
      return getDemoData(symbol);
    }

    // ==================== HISTORICAL DATA ====================
    async function fetchHistoricalData(symbol, period = '6mo') {
      const cleanSymbol = symbol.replace('.NS', '').toUpperCase().trim();
      
      try {
        const periodMap = { '3mo': '3mo', '6mo': '6mo', '1y': '1y' };
        const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${cleanSymbol}.NS?range=${periodMap[period]}&interval=1d`;
        const proxy = 'https://api.allorigins.win/raw?url=';
        
        const response = await fetch(proxy + encodeURIComponent(yahooUrl));
        const data = await response.json();
        
        if (!data.chart?.result?.[0]) throw new Error('No data');
        
        const result = data.chart.result[0];
        const timestamps = result.timestamp;
        const quote = result.indicators.quote[0];
        
        const ohlcv = [];
        for (let i = 0; i < timestamps.length; i++) {
          if (quote.close[i] !== null) {
            ohlcv.push({
              timestamp: timestamps[i] * 1000,
              date: new Date(timestamps[i] * 1000),
              open: quote.open[i],
              high: quote.high[i],
              low: quote.low[i],
              close: quote.close[i],
              volume: quote.volume[i]
            });
          }
        }
        
        return ohlcv;
      } catch (e) {
        console.error('Historical data failed:', e);
        return generateSyntheticData(symbol, period);
      }
    }

    function generateSyntheticData(symbol, period) {
      const days = period === '3mo' ? 60 : period === '6mo' ? 120 : 240;
      const basePrice = 1000 + Math.random() * 2000;
      const data = [];
      let price = basePrice;
      
      for (let i = days; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const change = (Math.random() - 0.5) * price * 0.02;
        price += change;
        
        data.push({
          timestamp: date.getTime(),
          date: date,
          open: price - change/2,
          high: price + Math.abs(change),
          low: price - Math.abs(change),
          close: price,
          volume: Math.floor(1000000 + Math.random() * 5000000)
        });
      }
      
      return data;
    }

    // ==================== TECHNICAL ANALYSIS ====================
    class TechnicalAnalysis {
      static SMA(data, period) {
        const result = [];
        for (let i = 0; i < data.length; i++) {
          if (i < period - 1) {
            result.push(null);
            continue;
          }
          let sum = 0;
          for (let j = 0; j < period; j++) {
            sum += data[i - j].close;
          }
          result.push(sum / period);
        }
        return result;
      }

      static RSI(data, period = 14) {
        const result = [];
        for (let i = 0; i < data.length; i++) {
          if (i < period) {
            result.push(null);
            continue;
          }
          
          let gains = 0, losses = 0;
          for (let j = 1; j <= period; j++) {
            const change = data[i - j + 1].close - data[i - j].close;
            if (change > 0) gains += change;
            else losses -= change;
          }
          
          const avgGain = gains / period;
          const avgLoss = losses / period;
          
          if (avgLoss === 0) result.push(100);
          else {
            const rs = avgGain / avgLoss;
            result.push(100 - (100 / (1 + rs)));
          }
        }
        return result;
      }

      static MACD(data, fast = 12, slow = 26) {
        const ema = (data, period) => {
          const result = [];
          const multiplier = 2 / (period + 1);
          for (let i = 0; i < data.length; i++) {
            if (i === 0) result.push(data[i].close);
            else {
              const val = (data[i].close - result[i-1]) * multiplier + result[i-1];
              result.push(val);
            }
          }
          return result;
        };
        
        const fastEMA = ema(data, fast);
        const slowEMA = ema(data, slow);
        const macdLine = fastEMA.map((v, i) => v - slowEMA[i]);
        
        // Signal line (9-day EMA of MACD)
        const signalLine = [];
        const mult = 2 / (9 + 1);
        for (let i = 0; i < macdLine.length; i++) {
          if (i === 0) signalLine.push(macdLine[i]);
          else signalLine.push((macdLine[i] - signalLine[i-1]) * mult + signalLine[i-1]);
        }
        
        return { macdLine, signalLine };
      }

      static SupportResistance(data, lookback = 20) {
        const recent = data.slice(-lookback);
        return {
          resistance: Math.max(...recent.map(d => d.high)),
          support: Math.min(...recent.map(d => d.low))
        };
      }
    }

    // ==================== SCORING ====================
    function calculateScore(data, indicators) {
      const current = data[data.length - 1];
      const scores = { trend: 0, momentum: 0, volume: 0, support: 0, volatility: 0 };
      
      // Trend
      const sma20 = indicators.sma20[indicators.sma20.length - 1];
      const sma50 = indicators.sma50[indicators.sma50.length - 1];
      if (sma20 && sma50) {
        if (sma20 > sma50) scores.trend = 20;
        else if (sma20 < sma50) scores.trend = 5;
        else scores.trend = 10;
      }
      
      // Momentum
      const rsi = indicators.rsi[indicators.rsi.length - 1];
      if (rsi) {
        if (rsi > 50 && rsi < 70) scores.momentum = 25;
        else if (rsi > 30 && rsi < 50) scores.momentum = 15;
        else if (rsi >= 70) scores.momentum = 10;
        else scores.momentum = 5;
      }
      
      // Volume
      const avgVolume = data.slice(-20).reduce((a, b) => a + b.volume, 0) / 20;
      if (current.volume > avgVolume * 1.5) scores.volume = 15;
      else if (current.volume > avgVolume) scores.volume = 10;
      else scores.volume = 5;
      
      // Support
      const { support } = indicators.levels;
      const distToSupport = ((current.close - support) / support) * 100;
      if (distToSupport < 3) scores.support = 20;
      else if (distToSupport < 5) scores.support = 15;
      else if (distToSupport < 10) scores.support = 10;
      else scores.support = 5;
      
      // Volatility (Bollinger position)
      const bb = indicators.bollinger?.[indicators.bollinger.length - 1];
      if (bb) {
        const range = bb.upper - bb.lower;
        const position = range > 0 ? (current.close - bb.lower) / range : 0.5;
        if (position > 0.4 && position < 0.6) scores.volatility = 20;
        else if (position < 0.2) scores.volatility = 15;
        else if (position > 0.8) scores.volatility = 10;
        else scores.volatility = 15;
      }
      
      const total = Object.values(scores).reduce((a, b) => a + b, 0);
      
      return {
        total,
        breakdown: scores,
        verdict: total >= 80 ? 'STRONG BUY' : total >= 65 ? 'BUY' : total >= 50 ? 'HOLD' : total >= 35 ? 'SELL' : 'STRONG SELL',
        confidence: total >= 75 ? 'HIGH' : total >= 60 ? 'MEDIUM' : 'LOW'
      };
    }

    // ==================== MAIN ANALYSIS ====================
    async function analyzeStock() {
      const symbol = $('#stockInput').value.trim().toUpperCase();
      if (!symbol) return alert('Please enter a symbol');

      $('#loading').style.display = 'block';
      $('#resultsPanel').innerHTML = '';

      try {
        $('#loading').innerHTML = 'üì° FETCHING DATA...';
        const quote = await fetchStockData(symbol);
        
        $('#loading').innerHTML = 'üìä CALCULATING INDICATORS...';
        const history = await fetchHistoricalData(symbol, '6mo');
        
        const indicators = {
          sma20: TechnicalAnalysis.SMA(history, 20),
          sma50: TechnicalAnalysis.SMA(history, 50),
          rsi: TechnicalAnalysis.RSI(history, 14),
          macd: TechnicalAnalysis.MACD(history),
          bollinger: TechnicalAnalysis.SMA(history, 20).map((v, i) => {
            if (!v) return null;
            const std = Math.sqrt(history.slice(i-19, i+1).reduce((a, b) => a + Math.pow(b.close - v, 2), 0) / 20);
            return { upper: v + 2*std, middle: v, lower: v - 2*std };
          }),
          levels: TechnicalAnalysis.SupportResistance(history)
        };
        
        const analysis = calculateScore(history, indicators);
        
        const currentPrice = quote.price;
        const { support, resistance } = indicators.levels;
        const risk = currentPrice - support;
        
        currentAnalysis = {
          symbol,
          company: quote.company,
          price: currentPrice,
          change: quote.change,
          percentChange: quote.percentChange,
          volume: quote.volume,
          analysis,
          indicators,
          targets: {
            entry: currentPrice,
            stopLoss: support * 0.98,
            target: resistance * 0.95,
            riskReward: risk > 0 ? ((resistance - currentPrice) / risk).toFixed(1) : 'N/A'
          },
          history: history.slice(-30),
          source: quote.source,
          timestamp: quote.timestamp,
          isDemo: quote.isDemo || false
        };

        renderResults(currentAnalysis);
        
      } catch (error) {
        $('#resultsPanel').innerHTML = `
          <div class="card error-box">
            <strong>‚ùå Analysis Failed</strong><br>
            ${error.message}
          </div>
        `;
      } finally {
        $('#loading').style.display = 'none';
      }
    }

    function renderResults(data) {
      const changeClass = data.change >= 0 ? 'change-positive' : 'change-negative';
      const changeSign = data.change >= 0 ? '+' : '';
      
      const statusBanner = data.isDemo ? 
        `<div class="demo-warning">‚ö†Ô∏è Using DEMO data - prices are not real. Yahoo Finance API may be blocked.</div>` :
        `<div class="real-data">‚úÖ REAL DATA from ${data.source}</div>`;

      $('#resultsPanel').innerHTML = `
        ${statusBanner}
        <div class="grid">
          <div class="col-8">
            <div class="card">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h1 style="font-family: var(--sans); margin: 0;">${data.symbol}</h1>
                  <div style="color: var(--ink2);">${data.company}</div>
                </div>
                <div>
                  <span class="signal-badge ${data.analysis.verdict.includes('BUY') ? 'signal-buy' : data.analysis.verdict.includes('SELL') ? 'signal-sell' : 'signal-neutral'}">
                    ${data.analysis.verdict}
                  </span>
                </div>
              </div>
              
              <div style="margin: 20px 0; display: flex; align-items: baseline; gap: 20px;">
                <span class="price-tag">‚Çπ${data.price.toFixed(2)}</span>
                <span class="${changeClass}">
                  ${changeSign}${data.change.toFixed(2)} (${changeSign}${data.percentChange.toFixed(2)}%)
                </span>
                <span style="color: var(--ink3); font-size: 12px;">
                  ${data.timestamp.toLocaleTimeString('en-IN')}
                </span>
              </div>
              
              <div class="chart-container">
                <canvas id="priceChart"></canvas>
              </div>
              
              <div class="grid" style="margin: 20px 0;">
                <div class="col-3">
                  <div class="metric-box">
                    <div class="metric-value">${data.indicators.rsi[data.indicators.rsi.length-1]?.toFixed(1) || 'N/A'}</div>
                    <div class="label">RSI (14)</div>
                  </div>
                </div>
                <div class="col-3">
                  <div class="metric-box">
                    <div class="metric-value">${(data.volume/1e6).toFixed(2)}M</div>
                    <div class="label">Volume</div>
                  </div>
                </div>
                <div class="col-3">
                  <div class="metric-box">
                    <div class="metric-value">‚Çπ${data.indicators.levels.support.toFixed(0)}</div>
                    <div class="label">Support</div>
                  </div>
                </div>
                <div class="col-3">
                  <div class="metric-box">
                    <div class="metric-value">‚Çπ${data.indicators.levels.resistance.toFixed(0)}</div>
                    <div class="label">Resistance</div>
                  </div>
                </div>
              </div>
              
              <h3 style="margin-bottom: 15px;">Technical Score Breakdown</h3>
              <div class="grid" style="grid-template-columns: 1fr 1fr;">
                ${Object.entries(data.analysis.breakdown).map(([key, score]) => `
                  <div class="pillar">
                    <div class="pillar-head">
                      <span>${key.toUpperCase()}</span>
                      <span class="pillar-score">${score}/20</span>
                    </div>
                    <div style="width: 100%; height: 4px; background: var(--border); border-radius: 2px; margin-top: 8px;">
                      <div style="width: ${(score/20)*100}%; height: 100%; background: var(--gold); border-radius: 2px;"></div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
          
          <div class="col-4">
            <div class="card">
              <div class="label">TECHNICAL SCORE</div>
              <div class="kpi-score">${data.analysis.total}%</div>
              
              <div style="margin: 20px 0;">
                <div class="pillar">
                  <div class="pillar-head">
                    <span>Entry</span>
                    <span class="pillar-score">‚Çπ${data.targets.entry.toFixed(2)}</span>
                  </div>
                </div>
                <div class="pillar">
                  <div class="pillar-head">
                    <span>Target</span>
                    <span class="pillar-score">‚Çπ${data.targets.target.toFixed(0)}</span>
                  </div>
                </div>
                <div class="pillar">
                  <div class="pillar-head">
                    <span>Stop Loss</span>
                    <span class="pillar-score" style="color: var(--danger);">‚Çπ${data.targets.stopLoss.toFixed(0)}</span>
                  </div>
                </div>
                <div class="pillar">
                  <div class="pillar-head">
                    <span>Risk/Reward</span>
                    <span class="pillar-score">1:${data.targets.riskReward}</span>
                  </div>
                </div>
              </div>
              
              <div class="pillar" style="background: ${data.analysis.confidence === 'HIGH' ? 'var(--success-light)' : data.analysis.confidence === 'MEDIUM' ? '#fef3c7' : '#fee2e2'};">
                <div class="pillar-head">
                  <span>Confidence</span>
                  <span>${data.analysis.confidence}</span>
                </div>
              </div>
              
              <button class="btn" onclick="saveToJournal()" style="margin-top: 20px;">üíæ SAVE TO JOURNAL</button>
            </div>
          </div>
        </div>
      `;

      const ctx = document.getElementById('priceChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.history.map(h => h.date.toLocaleDateString('en-IN', {month: 'short', day: 'numeric'})),
          datasets: [{
            label: 'Price',
            data: data.history.map(h => h.close),
            borderColor: '#b45309',
            backgroundColor: 'rgba(180, 83, 9, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { grid: { color: 'rgba(0,0,0,0.05)' } },
            x: { grid: { display: false } }
          }
        }
      });
    }

    // ==================== BACKTESTING ====================
    async function runBacktest() {
      const symbol = $('#backtestSymbol').value.toUpperCase().trim();
      const strategy = $('#strategySelect').value;
      const period = $('#periodSelect').value;
      const initialCapital = parseFloat($('#initialCapital').value) || 100000;
      
      $('#backtestResults').innerHTML = '<div class="loading" style="display: block;">RUNNING BACKTEST...</div>';
      
      try {
        const data = await fetchHistoricalData(symbol, period);
        if (data.length < 50) throw new Error('Insufficient data');
        
        const sma20 = TechnicalAnalysis.SMA(data, 20);
        const sma50 = TechnicalAnalysis.SMA(data, 50);
        const rsi = TechnicalAnalysis.RSI(data, 14);
        const macd = TechnicalAnalysis.MACD(data);
        
        let cash = initialCapital;
        let shares = 0;
        let trades = [];
        let equity = [];
        let position = null;
        let entryPrice = 0;
        
        for (let i = 50; i < data.length; i++) {
          const current = data[i];
          const prev = data[i-1];
          const currentEquity = cash + (shares * current.close);
          
          equity.push({ date: current.date, value: currentEquity });
          
          let signal = null;
          
          switch(strategy) {
            case 'sma_cross':
              if (sma20[i] > sma50[i] && sma20[i-1] <= sma50[i-1] && !position) signal = 'BUY';
              else if (sma20[i] < sma50[i] && sma20[i-1] >= sma50[i-1] && position === 'LONG') signal = 'SELL';
              break;
              
            case 'rsi_mean_reversion':
              if (rsi[i] < 30 && !position) signal = 'BUY';
              else if (rsi[i] > 70 && position === 'LONG') signal = 'SELL';
              break;
              
            case 'macd':
              if (macd.macdLine[i] > macd.signalLine[i] && macd.macdLine[i-1] <= macd.signalLine[i-1] && !position) signal = 'BUY';
              else if (macd.macdLine[i] < macd.signalLine[i] && macd.macdLine[i-1] >= macd.signalLine[i-1] && position === 'LONG') signal = 'SELL';
              break;
          }
          
          if (signal === 'BUY' && !position) {
            shares = Math.floor(cash / current.close);
            cash -= shares * current.close;
            entryPrice = current.close;
            position = 'LONG';
            trades.push({ type: 'BUY', date: current.date.toLocaleDateString('en-IN'), price: current.close, shares });
          }
          else if (signal === 'SELL' && position === 'LONG') {
            cash += shares * current.close;
            const pnl = (current.close - entryPrice) * shares;
            trades.push({ 
              type: 'SELL', 
              date: current.date.toLocaleDateString('en-IN'), 
              price: current.close, 
              shares, 
              pnl,
              pnlPercent: ((current.close - entryPrice) / entryPrice) * 100
            });
            shares = 0;
            position = null;
          }
        }
        
        if (position === 'LONG') {
          const lastPrice = data[data.length - 1].close;
          cash += shares * lastPrice;
          trades.push({
            type: 'SELL (Final)',
            date: data[data.length - 1].date.toLocaleDateString('en-IN'),
            price: lastPrice,
            shares,
            pnl: (lastPrice - entryPrice) * shares
          });
        }
        
        const finalEquity = cash;
        const totalReturn = ((finalEquity - initialCapital) / initialCapital) * 100;
        const winningTrades = trades.filter(t => t.pnl > 0);
        const winRate = trades.length > 0 ? (winningTrades.length / (trades.length/2)) * 100 : 0;
        
        // Render results
        const tradeRows = trades.map(t => `
          <div class="trade-row ${t.pnl > 0 ? 'change-positive' : t.pnl < 0 ? 'change-negative' : ''}">
            <div>${t.type}</div>
            <div>${t.date}</div>
            <div>‚Çπ${t.price.toFixed(2)}</div>
            <div>${t.shares || ''}</div>
            <div>${t.pnl ? `‚Çπ${t.pnl.toFixed(0)}` : ''}</div>
          </div>
        `).join('');

        $('#backtestResults').innerHTML = `
          <div class="grid" style="margin-bottom: 20px;">
            <div class="col-3">
              <div class="metric-box">
                <div class="metric-value ${totalReturn >= 0 ? 'change-positive' : 'change-negative'}">
                  ${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%
                </div>
                <div class="label">Total Return</div>
              </div>
            </div>
            <div class="col-3">
              <div class="metric-box">
                <div class="metric-value">${winRate.toFixed(1)}%</div>
                <div class="label">Win Rate</div>
              </div>
            </div>
            <div class="col-3">
              <div class="metric-box">
                <div class="metric-value">‚Çπ${finalEquity.toFixed(0)}</div>
                <div class="label">Final Value</div>
              </div>
            </div>
            <div class="col-3">
              <div class="metric-box">
                <div class="metric-value">${trades.filter(t => t.type === 'SELL').length}</div>
                <div class="label">Trades</div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <h4 style="margin-bottom: 15px;">Trade History</h4>
            <div class="trade-row trade-header">
              <div>Type</div>
              <div>Date</div>
              <div>Price</div>
              <div>Shares</div>
              <div>P&L</div>
            </div>
            ${tradeRows}
          </div>
        `;
        
      } catch (error) {
        $('#backtestResults').innerHTML = `<div class="card error-box">Error: ${error.message}</div>`;
      }
    }

    // ==================== JOURNAL ====================
    function saveToJournal() {
      if (!currentAnalysis) return;
      
      const entry = {
        symbol: currentAnalysis.symbol,
        price: currentAnalysis.price,
        score: currentAnalysis.analysis.total,
        verdict: currentAnalysis.analysis.verdict,
        target: currentAnalysis.targets.target,
        stopLoss: currentAnalysis.targets.stopLoss,
        date: new Date().toLocaleDateString('en-IN'),
        timestamp: Date.now()
      };
      
      journal.unshift(entry);
      localStorage.setItem('wps_journal', JSON.stringify(journal));
      updateJournalDisplay();
      
      const btn = event.target;
      btn.textContent = '‚úì SAVED!';
      setTimeout(() => btn.textContent = 'üíæ SAVE TO JOURNAL', 1500);
    }

    function updateJournalDisplay() {
      const container = $('#journalEntries');
      if (!journal.length) {
        container.innerHTML = '<div style="text-align: center; padding: 40px;">No entries yet</div>';
        return;
      }
      
      container.innerHTML = journal.map(e => `
        <div style="padding: 15px; border-bottom: 1px solid var(--border);">
          <div style="display: flex; justify-content: space-between;">
            <span><strong>${e.symbol}</strong></span>
            <span class="signal-badge ${e.verdict.includes('BUY') ? 'signal-buy' : 'signal-sell'}">${e.verdict}</span>
          </div>
          <div style="display: flex; gap: 20px; margin-top: 10px; font-size: 12px;">
            <span>‚Çπ${e.price}</span>
            <span>Score: ${e.score}%</span>
            <span>Target: ‚Çπ${e.target}</span>
            <span>${e.date}</span>
          </div>
        </div>
      `).join('');
    }

    function clearJournal() {
      if (confirm('Clear all entries?')) {
        journal = [];
        localStorage.removeItem('wps_journal');
        updateJournalDisplay();
      }
    }

    function exportJournal() {
      const dataStr = JSON.stringify(journal, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `journal-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    }

    // Events
    $('#analyzeBtn').addEventListener('click', analyzeStock);
    $('#stockInput').addEventListener('keypress', e => { if (e.key === 'Enter') analyzeStock(); });

    window.showPage = showPage;
    window.setSymbol = setSymbol;
    window.runBacktest = runBacktest;
    window.saveToJournal = saveToJournal;
    window.clearJournal = clearJournal;
    window.exportJournal = exportJournal;
  </script>
</body>
</html>