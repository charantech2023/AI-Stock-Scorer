<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WPS AI | Grounded Trading Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600;700&family=Syne:wght@800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #060810; --surface: #0d1117; --surface2: #141922; --border: #1e2d40;
  --text: #e2eaf5; --text2: #6b83a0; --gold: #e8b84b; --green: #34d48a; --red: #f04a4a;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'IBM Plex Mono', monospace; background: var(--bg); color: var(--text); min-height: 100vh; padding: 40px 20px; }
.container { max-width: 860px; margin: 0 auto; position: relative; z-index: 1; }
.header { margin-bottom: 30px; }
.title { font-family: 'Syne', sans-serif; font-size: 32px; color: var(--gold); }
.card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 24px; margin-bottom: 16px; }
.search-box { display: flex; gap: 10px; margin-bottom: 20px; }
.input-field { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 14px; color: #white; outline: none; }
.btn { padding: 14px 24px; background: var(--gold); border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }
.loading { display: none; text-align: center; color: var(--gold); margin: 20px 0; }
/* Grounding Styles */
.sources-box { background: var(--surface2); padding: 15px; border-radius: 10px; margin-top: 20px; border: 1px solid var(--border); }
.source-tag { display: inline-block; font-size: 10px; color: #4a9eff; margin-right: 10px; text-decoration: none; }
.suggestion-box { margin-top: 15px; padding: 10px; border-top: 1px solid var(--border); }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1 class="title">WPS.AI Scorer</h1>
    <p style="color:var(--text2)">Grounded in Live February 2026 Market Data</p>
  </div>

  <div class="card">
    <div style="margin-bottom:15px;">
      <input type="password" id="apiKey" class="input-field" placeholder="Enter Gemini API Key">
    </div>
    <div class="search-box">
      <input type="text" id="symbol" class="input-field" placeholder="e.g. LAURUSLABS">
      <button class="btn" onclick="analyze()">ANALYZE LIVE</button>
    </div>
  </div>

  <div id="loader" class="loading">SEARCHING LIVE WEB & ANALYZING...</div>
  <div id="results"></div>
</div>

<script>
const SYSTEM_PROMPT = `Analyze this stock using the 7-Pillar WPS Methodology. 
You MUST use Google Search to find current stock prices, recent news, and FII activity from February 2026.
Return ONLY JSON:
{
  "symbol": "SYM", "price": "â‚¹XXX", "wps": 0-100, "verdict": "Text",
  "pillars": [{"name":"P1", "score":80, "reason":"..."}]
}`;

async function analyze() {
  const sym = document.getElementById('symbol').value.toUpperCase();
  const key = document.getElementById('apiKey').value;
  const loader = document.getElementById('loader');
  const results = document.getElementById('results');

  if(!sym || !key) return alert("Missing details");
  loader.style.display = 'block';
  results.innerHTML = '';

  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: SYSTEM_PROMPT + "\n\nStock: " + sym }] }],
        tools: [{ google_search: {} }], // Enable real-time grounding
        generationConfig: { temperature: 1.0 } // Recommended for grounding
      })
    });

    const data = await response.json();
    const candidate = data.candidates[0];
    const rawContent = candidate.content.parts[0].text;
    const jsonStr = rawContent.match(/\{[\s\S]*\}/)[0];
    const result = JSON.parse(jsonStr);

    // Render Grounded Results
    results.innerHTML = `
      <div class="card">
        <h2 style="color:var(--gold)">${result.symbol} | ${result.price}</h2>
        <h3 style="margin: 10px 0">WPS Score: ${result.wps}%</h3>
        <p>${result.verdict}</p>
        <div class="sources-box">
          <p style="font-size:10px; color:var(--gold); margin-bottom:8px">LIVE SOURCES USED:</p>
          ${renderSources(candidate.groundingMetadata)}
        </div>
        <div id="google-suggestions" class="suggestion-box">
          ${candidate.groundingMetadata?.searchEntryPoint?.htmlContent || ''}
        </div>
      </div>
    `;
  } catch (e) {
    alert("Error: " + e.message);
  } finally {
    loader.style.display = 'none';
  }
}

function renderSources(meta) {
  if (!meta || !meta.groundingChunks) return "No live sources found.";
  return meta.groundingChunks.map((chunk, i) => 
    `<a href="${chunk.web.uri}" target="_blank" class="source-tag">[${i+1}] ${chunk.web.title}</a>`
  ).join('');
}
</script>
</body>
</html>