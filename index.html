<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WPS.AI | NSE Stock Auditor & Backtester</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;700&family=Syne:wght@700;800&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --ink: #0f172a;
      --ink2: #334155;
      --ink3: #64748b;
      --border: #e2e8f0;
      --gold: #b45309;
      --gold-light: #fbbf24;
      --gold-gradient: linear-gradient(135deg, #b45309 0%, #d97706 100%);
      --success: #059669;
      --danger: #dc2626;
      --mono: 'IBM Plex Mono', monospace;
      --sans: 'Syne', sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: var(--mono);
      font-size: 14px;
      line-height: 1.6;
    }

    /* Navigation */
    .nav {
      position: sticky;
      top: 0;
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
    }

    .nav-brand {
      font-family: var(--sans);
      font-weight: 800;
      font-size: 24px;
      letter-spacing: -0.5px;
    }

    .nav-brand span { color: var(--gold); }

    .nav-tabs {
      display: flex;
      gap: 8px;
    }

    .nav-tab {
      padding: 10px 20px;
      border: 1px solid var(--border);
      background: white;
      border-radius: 40px;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
      transition: all 0.2s;
    }

    .nav-tab:hover {
      border-color: var(--gold);
      background: var(--gold-gradient);
      color: white;
    }

    .nav-tab.active {
      border-color: var(--gold);
      background: var(--gold-gradient);
      color: white;
      box-shadow: 0 4px 12px rgba(180, 83, 9, 0.2);
    }

    /* Main Container */
    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .page { display: none; }
    .page.active { display: block; }

    /* Cards */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.02);
      transition: transform 0.2s;
    }

    .card:hover {
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
    }

    /* Grid System */
    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 20px;
    }

    .col-12 { grid-column: span 12; }
    .col-8 { grid-column: span 8; }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    .col-3 { grid-column: span 3; }

    /* Forms */
    .label {
      font-size: 11px;
      font-weight: 700;
      color: var(--ink3);
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      text-transform: uppercase;
    }

    .input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-family: var(--mono);
      font-size: 14px;
      margin-bottom: 16px;
      transition: all 0.2s;
    }

    .input:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 0 3px rgba(180, 83, 9, 0.1);
    }

    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 40px;
      background: var(--gold-gradient);
      color: white;
      font-weight: 800;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(180, 83, 9, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: white;
      color: var(--ink);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg);
      box-shadow: none;
    }

    /* KPI Elements */
    .kpi-score {
      font-family: var(--sans);
      font-size: 64px;
      font-weight: 800;
      color: var(--gold);
      line-height: 1;
      margin: 10px 0;
    }

    .pillar {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      transition: all 0.2s;
    }

    .pillar:hover {
      border-color: var(--gold);
      background: white;
    }

    .pillar-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 800;
      margin-bottom: 8px;
      font-size: 15px;
    }

    .pillar-score {
      color: var(--gold);
      background: rgba(180, 83, 9, 0.1);
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 12px;
    }

    .hr {
      height: 1px;
      background: var(--border);
      margin: 20px 0;
    }

    /* Status Indicators */
    .loading {
      display: none;
      text-align: center;
      padding: 40px;
      font-weight: 800;
      color: var(--gold);
      font-size: 16px;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-left: 10px;
      border: 2px solid var(--gold);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .backtest-badge {
      background: rgba(5, 150, 105, 0.1);
      color: var(--success);
      padding: 6px 12px;
      border-radius: 40px;
      font-size: 12px;
      font-weight: 700;
      display: inline-block;
    }

    .error-message {
      background: rgba(220, 38, 38, 0.1);
      color: var(--danger);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--danger);
      font-weight: 500;
    }

    /* Journal */
    .journal-entry {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .journal-symbol {
      font-weight: 800;
      font-size: 16px;
      color: var(--gold);
    }

    .journal-date {
      color: var(--ink3);
      font-size: 12px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
      .col-8, .col-4, .col-6, .col-3 {
        grid-column: span 1;
      }
      .nav {
        flex-direction: column;
        gap: 12px;
      }
    }
  </style>
</head>
<body>
  <nav class="nav">
    <div class="nav-brand">WPS<span>.</span>AI</div>
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showPage('scorer', this)">üìä AUDIT</button>
      <button class="nav-tab" onclick="showPage('journal', this)">üìì JOURNAL</button>
      <button class="nav-tab" onclick="showPage('about', this)">‚ÑπÔ∏è ABOUT</button>
    </div>
  </nav>

  <div class="main">
    <!-- Scorer Page -->
    <div class="page active" id="page-scorer">
      <div class="card">
        <div class="grid">
          <div class="col-6">
            <div class="label">üáÆüá≥ NSE SYMBOL</div>
            <input class="input" id="stockInput" placeholder="e.g. RELIANCE, TCS, HDFC" value="RELIANCE" />
          </div>
          <div class="col-6">
            <div class="label">üîë GEMINI API KEY</div>
            <input type="password" class="input" id="geminiKey" placeholder="Enter your API key" />
          </div>
          <div class="col-12">
            <button class="btn" id="analyzeBtn">üöÄ RUN 6-PILLAR AUDIT & BACKTEST</button>
          </div>
        </div>
        <div style="margin-top: 12px; font-size: 11px; color: var(--ink3); text-align: center;">
          ‚ö° Fetches real NSE data + AI analysis ‚Ä¢ 100% free
        </div>
      </div>

      <div id="loading" class="loading">FETCHING LIVE NSE DATA & ANALYZING...</div>
      <div id="resultsPanel"></div>
    </div>

    <!-- Journal Page -->
    <div class="page" id="page-journal">
      <div class="card">
        <h2 style="font-family: var(--sans); margin-bottom: 20px;">üìì Trade Journal</h2>
        <div id="journalEntries">
          <div style="text-align: center; padding: 40px; color: var(--ink3);">
            No entries yet. Run an audit to save a trade.
          </div>
        </div>
        <button class="btn btn-secondary" onclick="clearJournal()" style="margin-top: 20px;">üóëÔ∏è Clear All</button>
      </div>
    </div>

    <!-- About Page -->
    <div class="page" id="page-about">
      <div class="card">
        <h2 style="font-family: var(--sans); margin-bottom: 20px;">About WPS.AI</h2>
        <p style="margin-bottom: 16px;"><strong>6-Pillar Methodology:</strong></p>
        <ul style="list-style: none; padding: 0;">
          <li style="margin-bottom: 8px;">üìà Relative Strength (15%)</li>
          <li style="margin-bottom: 8px;">üìä Technical Analysis (25%)</li>
          <li style="margin-bottom: 8px;">üè≠ Sector Strength (10%)</li>
          <li style="margin-bottom: 8px;">üìë Fundamental Health (20%)</li>
          <li style="margin-bottom: 8px;">üëî Insider Activity (15%)</li>
          <li style="margin-bottom: 8px;">‚öñÔ∏è Risk/Reward (15%)</li>
        </ul>
        <div class="hr"></div>
        <p style="color: var(--ink3);">Built for NSE India ‚Ä¢ Real-time data ‚Ä¢ AI-powered analysis</p>
        <p style="margin-top: 16px; font-size: 12px;">‚ö†Ô∏è For educational purposes only. Not investment advice.</p>
      </div>
    </div>
  </div>

  <script>
    // ==================== CONFIGURATION ====================
    const NSE_API = 'https://military-jobye-haiqstudios-14f59639.koyeb.app/stock';
    const GEMINI_MODEL = 'gemini-2.0-flash';
    
    // ==================== UTILITIES ====================
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);
    
    let currentAnalysis = null;
    
    // Load journal from localStorage
    let journal = JSON.parse(localStorage.getItem('wps_journal') || '[]');
    updateJournalDisplay();

    // ==================== PAGE NAVIGATION ====================
    function showPage(pageId, btn) {
      $$('.page').forEach(p => p.classList.remove('active'));
      $$('.nav-tab').forEach(t => t.classList.remove('active'));
      $(`#page-${pageId}`).classList.add('active');
      if (btn) btn.classList.add('active');
    }

    // ==================== NSE DATA FETCHING ====================
    async function fetchNSEStockData(symbol) {
      // Clean symbol - remove .NS if present, we'll add it
      const cleanSymbol = symbol.replace('.NS', '').toUpperCase();
      const url = `${NSE_API}?symbol=${cleanSymbol}.NS&res=num`;
      
      console.log('Fetching NSE data from:', url);
      
      const response = await fetch(url);
      const data = await response.json();
      
      if (data.status === 'success') {
        return {
          price: data.data.last_price,
          company: data.data.company_name,
          dayHigh: data.data.day_high,
          dayLow: data.data.day_low,
          volume: data.data.volume,
          change: data.data.change,
          percentChange: data.data.percent_change,
          pe: data.data.pe_ratio,
          sector: data.data.sector || 'N/A',
          marketCap: data.data.market_cap,
          weekHigh52: data.data.high_52_week,
          weekLow52: data.data.low_52_week
        };
      }
      throw new Error(data.message || 'Failed to fetch NSE data');
    }

    // ==================== GEMINI ANALYSIS ====================
    async function analyzeWithGemini(stockData, symbol, apiKey) {
      const prompt = `You are WPS.AI, a professional stock auditor. Analyze this REAL NSE India stock data:

SYMBOL: ${symbol}
COMPANY: ${stockData.company}
CURRENT PRICE: ‚Çπ${stockData.price}
DAY RANGE: ‚Çπ${stockData.dayLow} - ‚Çπ${stockData.dayHigh}
52-WEEK RANGE: ‚Çπ${stockData.weekLow52} - ‚Çπ${stockData.weekHigh52}
VOLUME: ${stockData.volume}
P/E RATIO: ${stockData.pe}
SECTOR: ${stockData.sector}
CHANGE: ${stockData.change} (${stockData.percentChange}%)

Perform a 6-pillar audit (Relative Strength 15%, Technical 25%, Sector 10%, Fundamental 20%, Insiders 15%, R:R 15%).
Based on the 52-week range and current price, calculate momentum.
Provide realistic scores and a brief backtest simulation.

Return ONLY valid JSON with this exact structure:
{
  "symbol": "${symbol}",
  "company": "${stockData.company}",
  "wps": <0-100>,
  "verdict": "BULLISH/BEARISH/NEUTRAL",
  "pillars": [
    {"name": "Relative Strength", "score": <0-100>, "summary": "brief"},
    {"name": "Technical", "score": <0-100>, "summary": "brief"},
    {"name": "Sector", "score": <0-100>, "summary": "brief"},
    {"name": "Fundamental", "score": <0-100>, "summary": "brief"},
    {"name": "Insiders", "score": <0-100>, "summary": "brief"},
    {"name": "Risk/Reward", "score": <0-100>, "summary": "brief"}
  ],
  "targets": {
    "t1": <price>,
    "sl": <price>
  },
  "backtest": {
    "win_rate": <0-100>,
    "trades": <number>
  }
}`;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.1, responseMimeType: "application/json" }
        })
      });

      const data = await response.json();
      
      if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
        throw new Error('Invalid Gemini response');
      }
      
      const rawJson = data.candidates[0].content.parts[0].text;
      // Clean markdown if present
      const jsonStr = rawJson.replace(/```json\n?|\n?```/g, '').trim();
      return JSON.parse(jsonStr);
    }

    // ==================== MAIN ANALYSIS FUNCTION ====================
    async function analyzeStock() {
      const symbol = $('#stockInput').value.trim().toUpperCase();
      const apiKey = $('#geminiKey').value.trim();
      
      if (!symbol) return alert('Please enter an NSE symbol');
      if (!apiKey) return alert('Please enter your Gemini API key');

      $('#loading').style.display = 'block';
      $('#resultsPanel').innerHTML = '';

      try {
        // Step 1: Fetch real NSE data
        $('#loading').innerHTML = 'üì° FETCHING LIVE NSE DATA...';
        const stockData = await fetchNSEStockData(symbol);
        
        // Step 2: Analyze with Gemini
        $('#loading').innerHTML = 'ü§ñ AI ANALYZING 6 PILLARS...';
        const analysis = await analyzeWithGemini(stockData, symbol, apiKey);
        
        // Add the real CMP
        analysis.cmp = stockData.price;
        currentAnalysis = analysis;
        
        // Step 3: Render results
        renderResults(analysis);
        
      } catch (error) {
        $('#resultsPanel').innerHTML = `
          <div class="card error-message">
            <strong>‚ùå Analysis Failed</strong><br>
            ${error.message}
          </div>
        `;
      } finally {
        $('#loading').style.display = 'none';
        $('#loading').innerHTML = 'FETCHING LIVE NSE DATA & ANALYZING...';
      }
    }

    // ==================== RENDER RESULTS ====================
    function renderResults(data) {
      const pillarsHtml = data.pillars.map(p => `
        <div class="pillar">
          <div class="pillar-head">
            <span>${p.name}</span>
            <span class="pillar-score">${p.score}%</span>
          </div>
          <div style="color: var(--ink2); font-size: 12px;">${p.summary}</div>
        </div>
      `).join('');

      $('#resultsPanel').innerHTML = `
        <div class="grid">
          <div class="col-8">
            <div class="card">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 style="font-family: var(--sans); margin: 0;">${data.symbol}</h1>
                <span class="backtest-badge">üìä BACKTEST: ${data.backtest.win_rate}% WIN RATE (${data.backtest.trades} TRADES)</span>
              </div>
              <div style="margin-top: 8px; color: var(--ink2);">
                ${data.company} | CMP: ‚Çπ${data.cmp}
              </div>
              <div class="hr"></div>
              <p style="font-size: 15px;">${data.verdict}: Based on multi-factor analysis and historical patterns.</p>
              
              <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
                <div class="pillar" style="background: rgba(5, 150, 105, 0.05);">
                  <div style="font-size: 11px; color: var(--ink3);">TARGET 1</div>
                  <div style="font-size: 24px; font-weight: 800; color: var(--success);">‚Çπ${data.targets.t1}</div>
                </div>
                <div class="pillar" style="background: rgba(220, 38, 38, 0.05);">
                  <div style="font-size: 11px; color: var(--ink3);">STOP LOSS</div>
                  <div style="font-size: 24px; font-weight: 800; color: var(--danger);">‚Çπ${data.targets.sl}</div>
                </div>
              </div>
            </div>
            
            <h3 style="font-family: var(--sans); margin: 20px 0 10px;">6-Pillar Breakdown</h3>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
              ${pillarsHtml}
            </div>
          </div>
          
          <div class="col-4">
            <div class="card" style="text-align: center; position: sticky; top: 100px;">
              <div class="label">FINAL WPS SCORE</div>
              <div class="kpi-score">${data.wps}%</div>
              <div style="width: 100%; height: 6px; background: var(--border); border-radius: 3px; margin: 20px 0;">
                <div style="width: ${data.wps}%; height: 100%; background: var(--gold-gradient); border-radius: 3px;"></div>
              </div>
              <button class="btn" onclick="saveToJournal()">üíæ SAVE TO JOURNAL</button>
              <button class="btn btn-secondary" style="margin-top: 10px;" onclick="window.print()">üñ®Ô∏è PRINT REPORT</button>
            </div>
          </div>
        </div>
      `;
    }

    // ==================== JOURNAL FUNCTIONS ====================
    function saveToJournal() {
      if (!currentAnalysis) return;
      
      const entry = {
        symbol: currentAnalysis.symbol,
        company: currentAnalysis.company,
        wps: currentAnalysis.wps,
        verdict: currentAnalysis.verdict,
        date: new Date().toLocaleDateString('en-IN'),
        timestamp: Date.now()
      };
      
      journal.unshift(entry); // Add to beginning
      localStorage.setItem('wps_journal', JSON.stringify(journal));
      
      updateJournalDisplay();
      
      // Show confirmation
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = '‚úì SAVED!';
      btn.style.background = 'linear-gradient(135deg, #059669, #10b981)';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = 'var(--gold-gradient)';
      }, 1500);
    }

    function updateJournalDisplay() {
      const container = $('#journalEntries');
      
      if (journal.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--ink3);">No entries yet. Run an audit to save a trade.</div>';
        return;
      }
      
      container.innerHTML = journal.map(entry => `
        <div class="journal-entry">
          <div>
            <span class="journal-symbol">${entry.symbol}</span>
            <span style="margin-left: 10px; color: var(--ink2);">${entry.company}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 15px;">
            <span style="background: var(--gold-gradient); color: white; padding: 4px 10px; border-radius: 40px; font-weight: 700;">${entry.wps}%</span>
            <span class="journal-date">${entry.date}</span>
            <span style="color: ${entry.verdict === 'BULLISH' ? 'var(--success)' : entry.verdict === 'BEARISH' ? 'var(--danger)' : 'var(--ink3)'};">${entry.verdict}</span>
          </div>
        </div>
      `).join('');
    }

    function clearJournal() {
      if (confirm('Clear all journal entries?')) {
        journal = [];
        localStorage.removeItem('wps_journal');
        updateJournalDisplay();
      }
    }

    // ==================== EVENT LISTENERS ====================
    $('#analyzeBtn').addEventListener('click', analyzeStock);
    
    // Allow Enter key in input
    $('#stockInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') analyzeStock();
    });
    
    $('#geminiKey').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') analyzeStock();
    });

    // ==================== EXPORT FUNCTIONS TO GLOBAL SCOPE ====================
    window.showPage = showPage;
    window.saveToJournal = saveToJournal;
    window.clearJournal = clearJournal;
  </script>
</body>
</html>